package com.kongole.stirlingproxy.controller;

import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import jakarta.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.util.Collections;

@RestController
@RequestMapping("/get")
public class StirlingPdfFullProxyController {

    private final RestTemplate restTemplate = new RestTemplate();
    private final String BASE_URL = "https://stirling-pdf-railway-poetic-courtesy.up.railway.app";

    @PostMapping("/**")
    public ResponseEntity<String> proxyPost(HttpServletRequest request,
                                            @RequestBody(required = false) String body,
                                            @RequestHeader HttpHeaders headers) throws IOException {
        String path = extractPath(request);
        String targetUrl = BASE_URL + path;

        HttpEntity<String> proxyRequest = new HttpEntity<>(body, headers);
        return restTemplate.exchange(targetUrl, HttpMethod.POST, proxyRequest, String.class);
    }

    @GetMapping("/**")
    public ResponseEntity<String> proxyGet(HttpServletRequest request,
                                           @RequestHeader HttpHeaders headers) {
        String path = extractPath(request);
        String targetUrl = BASE_URL + path;

        HttpEntity<Void> proxyRequest = new HttpEntity<>(headers);
        return restTemplate.exchange(targetUrl, HttpMethod.GET, proxyRequest, String.class);
    }

    private String extractPath(HttpServletRequest request) {
        String uri = request.getRequestURI();
        return uri.replaceFirst("/get", "");
    }
}

